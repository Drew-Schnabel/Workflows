name: Insurance Business Services Build - A.R.C.H.E.R

on:
  push:
    branches:
      - development  # Trigger on push to the development branch

jobs:
  # Job 1: Setup Environment and Resources
  Setup-Environment-and-Resources:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'  # Specify Node.js version

      - name: Authenticate with GitHub (using PAT secret)
        run: |
          git config --global url."https://${{ secrets.PAT }}@github.com/".insteadOf "https://github.com/"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Create Insurance-Business-Services folder
        run: mkdir -p Insurance-Business-Services

      - name: Clone LIPAS-Client Repository
        run: |
          git clone --branch development https://github.com/VAINS-Dev/LIPAS-Client.git Insurance-Business-Services/LIPAS-Client
          cd Insurance-Business-Services/LIPAS-Client
          npm install

      - name: Clone A.R.C.H.E.R Repository
        run: |
          git clone --branch development https://github.com/VAINS-Dev/A.R.C.H.E.R.git Insurance-Business-Services/A.R.C.H.E.R
          cd Insurance-Business-Services/A.R.C.H.E.R
          npm install

      - name: Log successful completion of resource fetching
        run: echo "Repositories successfully cloned and dependencies installed."

      - name: Archive Insurance-Business-Services folder
        run: |
          tar -czf insurance-business-services.tar.gz Insurance-Business-Services/
          echo "Folder archived successfully."

      - name: Upload Resources as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: insurance-business-services
          path: insurance-business-services.tar.gz

      - name: Remove temporary archive file
        run: rm insurance-business-services.tar.gz

      - name: List contents before uploading artifact (debug)
        run: ls -al Insurance-Business-Services/

  # Job 2: Setup Database
  Setup-Database:
    runs-on: ubuntu-latest
    needs: Setup-Environment-and-Resources  # Ensure resources are fetched first

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: "Y"
          SA_PASSWORD: ${{ secrets.SA_PASSWORD }}  # Use secret for SA_PASSWORD
        ports:
          - 1433:1433

    steps:
      - name: Download Resources Artifact
        uses: actions/download-artifact@v3
        with:
          name: insurance-business-services  # Must match the uploaded artifact name
          path: .

      - name: Extract Insurance-Business-Services
        run: |
          tar -xzf insurance-business-services.tar.gz
          echo "Insurance-Business-Services extracted successfully."

      - name: List directories for debugging
        run: |
          echo "Listing Insurance-Business-Services:"
          ls -la Insurance-Business-Services/
          echo "Listing LIPAS-Client/.GitHub-CI/Database:"
          ls -la Insurance-Business-Services/LIPAS-Client/.GitHub-CI/Database/

      - name: Install SQLCMD Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y mssql-tools unixodbc-dev
          echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc
          source ~/.bashrc

      - name: Wait for SQL Server to be Ready
        run: |
          for i in {1..30}; do  # Increased retries and wait time
            echo "Attempt $i to connect to SQL Server"
            if /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P "${{ secrets.SA_PASSWORD }}" -Q "SELECT 1" > /dev/null 2>&1; then
              echo "SQL Server is ready!"
              break
            fi
            echo "Waiting for SQL Server..."
            sleep 10
          done

          # Fail the step if the server is still not available
          if ! /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P "${{ secrets.SA_PASSWORD }}" -Q "SELECT 1"; then
            echo "SQL Server is not ready after waiting."
            exit 1
          fi

      - name: Execute SQL Scripts
        run: |
          # Navigate to the folder containing the SQL scripts
          cd Insurance-Business-Services/LIPAS-Client/.GitHub-CI/Database

          # List the files for debugging
          echo "Listing SQL scripts:"
          ls -la

          # Run all SQL scripts in the directory
          for sql_file in *.sql; do
            echo "Executing $sql_file"
            /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P "${{ secrets.SA_PASSWORD }}" -d master -i "$sql_file"
            if [ $? -ne 0 ]; then
              echo "Error executing $sql_file"
              exit 1
            fi
          done

  # Job 3: Mockoon Setup
  mockoon:
    runs-on: ubuntu-latest
    needs: Setup-Database  # Ensure Setup-Database job is completed

    steps:
      - name: Download Resources Artifact
        uses: actions/download-artifact@v3
        with:
          name: insurance-business-services
          path: .

      - name: Extract Insurance-Business-Services
        run: |
          tar -xzf insurance-business-services.tar.gz
          echo "Insurance-Business-Services extracted successfully."

      - name: List directories for debugging
        run: |
          echo "Listing Insurance-Business-Services:"
          ls -la Insurance-Business-Services/
          echo "Listing LIPAS-Client/.GitHub-CI/Mockoon:"
          ls -la Insurance-Business-Services/LIPAS-Client/.GitHub-CI/Mockoon/

      - name: Set up Mockoon CLI
        run: |
          # Update the Mockoon CLI version to the latest stable release
          MOCKOON_VERSION="1.4.3"  # Replace with the latest stable version
          MOCKOON_URL="https://github.com/mockoon/mockoon-cli/releases/download/v${MOCKOON_VERSION}/mockoon-cli-${MOCKOON_VERSION}-linux-x86_64.tar.gz"

          # Download the Mockoon CLI tar.gz file
          curl -f -sSL "$MOCKOON_URL" -o mockoon-cli.tar.gz

          # Verify the file was downloaded correctly
          if [[ ! -s mockoon-cli.tar.gz ]]; then
            echo "Mockoon CLI download failed or file is empty."
            exit 1
          fi

          # Verify the file type
          FILE_TYPE=$(file mockoon-cli.tar.gz)
          echo "Downloaded file type: $FILE_TYPE"
          if [[ "$FILE_TYPE" != *"gzip compressed data"* ]]; then
            echo "Downloaded file is not a valid gzip archive."
            exit 1
          fi

          # Extract the tar.gz file
          tar -xzvf mockoon-cli.tar.gz

          # Move the mockoon-cli binary to /usr/local/bin
          sudo mv mockoon-cli /usr/local/bin/mockoon-cli

          # Verify Mockoon CLI installation
          mockoon-cli --version

          # Clean up
          rm mockoon-cli.tar.gz

      - name: Start Mockoon Servers
        run: |
          cd Insurance-Business-Services/LIPAS-Client
          nohup mockoon-cli start --data ./.GitHub-CI/Mockoon/V20.SP4/EXL_LifePRO_LPRestClaimAPI.json --port 3000 > ./mockoon-3000.log 2>&1 &
          nohup mockoon-cli start --data ./.GitHub-CI/Mockoon/V20.SP4/EXL_LifePRO_LPRestPartyAPI.json --port 3001 > ./mockoon-3001.log 2>&1 &
          nohup mockoon-cli start --data ./.GitHub-CI/Mockoon/V20.SP4/EXL_LifePRO_LPRestPolicyAPI.json --port 3002 > ./mockoon-3002.log 2>&1 &
          nohup mockoon-cli start --data ./.GitHub-CI/Mockoon/V20.SP4/EXL_LifePRO_LPRestProductAPI.json --port 3003 > ./mockoon-3003.log 2>&1 &
          nohup mockoon-cli start --data ./.GitHub-CI/Mockoon/V20.SP4/EXL_LifePRO_UserMgmtService.json --port 3004 > ./mockoon-3004.log 2>&1 &
          nohup mockoon-cli start --data ./.GitHub-CI/Mockoon/LDS/LDS_Workflow_CommonService.json --port 3005 > ./mockoon-3005.log 2>&1 &
          nohup mockoon-cli start --data ./.GitHub-CI/Mockoon/LDS/LDS_Workflow_UnderWritingService.json --port 3006 > ./mockoon-3006.log 2>&1 &
          nohup mockoon-cli start --data ./.GitHub-CI/Mockoon/LDS/LDS_Workflow_WorkflowService.json --port 3007 > ./mockoon-3007.log 2>&1 &
          nohup mockoon-cli start --data ./.GitHub-CI/Mockoon/InsuranceServices/InsuranceServices.json --port 3008 > ./mockoon-3008.log 2>&1 &

      - name: Wait for Mockoon Servers to Start
        run: |
          for port in 3000 3001 3002 3003 3004 3005 3006 3007 3008; do
            for i in {1..10}; do
              if curl --silent http://localhost:$port > /dev/null; then
                echo "Mockoon server on port $port is ready"
                break
              fi
              echo "Waiting for Mockoon server on port $port..."
              sleep 3
            done
          done

      - name: Check Mockoon Logs
        run: |
          tail ./mockoon-*.log

      - name: Log Mockoon service is running
        run: |
          ps aux | grep mockoon

  # Job 4: Build and Deploy
  Build-And-Deploy:
    runs-on: ubuntu-latest
    needs: mockoon  # Ensure that repositories are cloned and services are set up first

    steps:
      - name: Download Resources Artifact
        uses: actions/download-artifact@v3
        with:
          name: insurance-business-services
          path: .

      - name: Extract Insurance-Business-Services
        run: |
          tar -xzf insurance-business-services.tar.gz
          echo "Insurance-Business-Services extracted successfully."

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'  # Specify Node.js version

      - name: Authenticate with GitHub (using PAT secret)
        run: |
          git config --global url."https://${{ secrets.PAT }}@github.com/".insteadOf "https://github.com/"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Log successful completion of resource fetching in Build-And-Deploy
        run: echo "Repositories successfully fetched from artifacts."

      - name: Build and deploy
        run: |
          # Navigate to your application directory if needed
          cd Insurance-Business-Services/LIPAS-Client  # or appropriate directory
          # Your build and deploy commands here
          echo "Build and deploy completed!"